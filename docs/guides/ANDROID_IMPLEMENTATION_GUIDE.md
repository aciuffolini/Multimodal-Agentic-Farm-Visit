# Android Implementation Guide

## ‚úÖ What's Been Created

### 1. Sensor Abstraction Layer (Complete)

**Location**: `apps/web/src/lib/sensors/`

- ‚úÖ `ISensorProvider.ts` - Interface defining sensor contracts
- ‚úÖ `AndroidProvider.ts` - Android native implementation (Capacitor)
- ‚úÖ `WebProvider.ts` - Web API fallback
- ‚úÖ `SensorManager.ts` - Factory that auto-detects platform

### 2. React Hooks (Complete)

**Location**: `apps/web/src/hooks/`

- ‚úÖ `useGPS.ts` - GPS location hook
- ‚úÖ `useCamera.ts` - Camera capture hook
- ‚úÖ `useMicrophone.ts` - Audio recording hook

### 3. Configuration Files

- ‚úÖ `capacitor.config.ts` - Capacitor Android configuration
- ‚úÖ Android permissions documented in `ANDROID_ARCHITECTURE.md`

---

## üî® Next Steps to Complete Android Integration

### Step 1: Install Capacitor Dependencies

```bash
cd apps/web
npm install @capacitor/camera @capacitor/geolocation @capacitor/filesystem
```

### Step 2: Add Android Platform

```bash
npx cap add android
```

### Step 3: Update package.json

Add to `apps/web/package.json`:

```json
{
  "dependencies": {
    "@capacitor/camera": "^7.1.0",
    "@capacitor/geolocation": "^7.0.0",
    "@capacitor/filesystem": "^7.1.0",
    "@capacitor/core": "^7.4.3",
    "@capacitor/android": "^7.4.3"
  }
}
```

### Step 4: Update AndroidManifest.xml

**File**: `apps/web/android/app/src/main/AndroidManifest.xml`

Add these permissions (should be auto-generated by Capacitor, but verify):

```xml
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
<uses-permission android:name="android.permission.INTERNET" />
```

### Step 5: Create Component Example

**File**: `apps/web/src/components/FieldVisitAndroid.tsx`

```typescript
import React from 'react';
import { useGPS } from '../hooks/useGPS';
import { useCamera } from '../hooks/useCamera';
import { useMicrophone } from '../hooks/useMicrophone';

export function FieldVisitAndroid() {
  const { gps, error: gpsError, loading: gpsLoading, getGPS } = useGPS();
  const { photo, loading: photoLoading, capturePhoto, clearPhoto } = useCamera();
  const { recording, audioUrl, startRecording, stopRecording } = useMicrophone();

  return (
    <div className="p-4">
      <h1>Field Visit Capture</h1>

      {/* GPS */}
      <section className="mb-4">
        <button onClick={getGPS} disabled={gpsLoading}>
          {gpsLoading ? 'Getting GPS...' : 'Get GPS Location'}
        </button>
        {gps && (
          <p>Location: {gps.lat}, {gps.lon} (¬±{gps.acc}m)</p>
        )}
        {gpsError && <p className="text-red-500">Error: {gpsError}</p>}
      </section>

      {/* Camera */}
      <section className="mb-4">
        <button onClick={() => capturePhoto()} disabled={photoLoading}>
          {photoLoading ? 'Capturing...' : 'Take Photo'}
        </button>
        {photo && (
          <div>
            <img src={photo} alt="Field photo" className="max-w-xs" />
            <button onClick={clearPhoto}>Clear</button>
          </div>
        )}
      </section>

      {/* Microphone */}
      <section className="mb-4">
        {!recording ? (
          <button onClick={startRecording}>Start Recording</button>
        ) : (
          <button onClick={stopRecording}>Stop Recording</button>
        )}
        {audioUrl && (
          <div>
            <audio controls src={audioUrl} />
          </div>
        )}
      </section>
    </div>
  );
}
```

### Step 6: Build and Test

```bash
# Build web app
npm run build

# Sync to Android
npx cap sync android

# Open in Android Studio
npx cap open android

# Run on device
npx cap run android
```

---

## üß™ Testing Checklist

### GPS Testing
- [ ] Request location permission
- [ ] Get current GPS coordinates
- [ ] Display accuracy
- [ ] Test on real device (emulator GPS is simulated)

### Camera Testing
- [ ] Request camera permission
- [ ] Open native camera app
- [ ] Capture photo
- [ ] Display captured photo
- [ ] Test photo quality/compression

### Microphone Testing
- [ ] Request microphone permission
- [ ] Start recording (show indicator)
- [ ] Stop recording
- [ ] Playback recorded audio
- [ ] Test audio quality

### Integration Testing
- [ ] Capture GPS + Photo + Audio in one session
- [ ] Save all data locally
- [ ] Sync to server when online
- [ ] Test offline mode (no internet)

---

## üîç Debugging Tips

### GPS Issues
```bash
# Check if location services are enabled
adb shell settings get secure location_providers_allowed

# Grant location permission manually
adb shell pm grant com.farmvisit.app android.permission.ACCESS_FINE_LOCATION
```

### Camera Issues
```bash
# Grant camera permission
adb shell pm grant com.farmvisit.app android.permission.CAMERA

# Check if camera hardware is available
adb shell pm list features | grep camera
```

### Audio Issues
```bash
# Grant microphone permission
adb shell pm grant com.farmvisit.app android.permission.RECORD_AUDIO

# Test audio recording
adb shell am start -a android.media.action.SOUND_RECORDER
```

---

## üì± Android-Specific Considerations

### 1. Permissions Runtime Request

Android 6+ requires runtime permission requests. Capacitor handles this automatically, but you can customize:

```typescript
// In AndroidProvider.ts, requestPermissions() already handles this
const perms = await this.checkPermissions();
if (perms.camera !== 'granted') {
  await Camera.requestPermissions(); // Capacitor shows native dialog
}
```

### 2. Background Location

For GPS tracking in background:
```xml
<!-- AndroidManifest.xml -->
<uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
```

### 3. File Storage

Photos are stored in app's private directory by default. For public access:

```typescript
// Use Filesystem plugin to save to public directory
import { Filesystem, Directory } from '@capacitor/filesystem';

const photo = await Camera.getPhoto({
  resultType: CameraResultType.Uri,
});

const savedFile = await Filesystem.writeFile({
  path: `photos/photo_${Date.now()}.jpg`,
  data: photo.base64String || '',
  directory: Directory.Data, // or Directory.External for public
});
```

### 4. Audio Playback

Native audio playback works automatically with HTML5 Audio API on Android WebView.

---

## üöÄ Production Build

### Generate Signed APK

```bash
cd apps/web/android
./gradlew assembleRelease

# APK location:
# android/app/build/outputs/apk/release/app-release.apk
```

### Generate AAB (for Play Store)

```bash
cd apps/web/android
./gradlew bundleRelease

# AAB location:
# android/app/build/outputs/bundle/release/app-release.aab
```

---

## üìö Additional Resources

- [Capacitor Camera Docs](https://capacitorjs.com/docs/apis/camera)
- [Capacitor Geolocation Docs](https://capacitorjs.com/docs/apis/geolocation)
- [Android Permissions Guide](https://developer.android.com/training/permissions/usage-notes)

---

**Status**: Sensor abstraction layer ‚úÖ Complete  
**Next**: Wire up components and test on Android device! üöÄ


